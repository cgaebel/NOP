#include "FastSystemCall.h"

static DWORD _Version;

static DWORD syscallTable[201][6] = {
	/* NT 4,  2000,   XP,     2k3S,   Vista,  7 */
	{ 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0060 }, /* NtAcceptConnectPort */
	{ 0x0001, 0x0001, 0x0001, 0x0001, 0x0001, 0x0061 }, /* NtAccessCheck */
	{ 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0026 }, /* NtAccessCheckAndAuditAlarm */
	{ 0x0003, 0x0008, 0x0008, 0x0008, 0x0008, 0x0008 }, /* NtAddAtom */
	{ 0x0004, 0x0009, 0x000a, 0x000b, 0x000b, 0x0068 }, /* NtAdjustGroupsToken */
	{ 0x0005, 0x000a, 0x000b, 0x000c, 0x000c, 0x003e }, /* NtAdjustPrivilegesToken */
	{ 0x0006, 0x000b, 0x000c, 0x000d, 0x000d, 0x0069 }, /* NtAlertResumeThread */
	{ 0x0007, 0x000c, 0x000d, 0x000e, 0x000e, 0x006a }, /* NtAlertThread */
	{ 0x0008, 0x000d, 0x000e, 0x000f, 0x000f, 0x006b }, /* NtAllocateLocallyUniqueId */
	{ 0x0009, 0x000f, 0x0010, 0x0011, 0x0011, 0x006e }, /* NtAllocateUuids */
	{ 0x000a, 0x0010, 0x0011, 0x0012, 0x0012, 0x0015 }, /* NtAllocateVirtualMemory */
	{ 0x000b, 0x0013, 0x0014, 0x0016, 0x002a, 0x0002 }, /* NtCallbackReturn */
	{ 0x000c, 0x0014, 0x0016, 0x0018, 0x002c, 0x005a }, /* NtCancelIoFile */
	{ 0x000d, 0x0015, 0x0017, 0x0019, 0x002d, 0x005e }, /* NtCancelTimer */
	{ 0x000e, 0x0017, 0x0018, 0x001a, 0x002e, 0x003b }, /* NtClearEvent */
	{ 0x000f, 0x0018, 0x0019, 0x001b, 0x002f, 0x000c }, /* NtClose */
	{ 0x0010, 0x0019, 0x001a, 0x001c, 0x0030, 0x0038 }, /* NtCloseObjectAuditAlarm */
	{ 0x0011, 0x001a, 0x001d, 0x001f, 0x0033, 0x0039 }, /* NtCompleteConnectPort */
	{ 0x0012, 0x001b, 0x001f, 0x0021, 0x0035, 0x008f }, /* NtConnectPort */
	{ 0x0013, 0x001c, 0x0020, 0x0022, 0x0036, 0x0040 }, /* NtContinue */
	{ 0x0014, 0x001d, 0x0022, 0x0024, 0x0038, 0x0091 }, /* NtCreateDirectoryObject */
	{ 0x0015, 0x001e, 0x0023, 0x0025, 0x0039, 0x0045 }, /* NtCreateEvent */
	{ 0x0016, 0x001f, 0x0024, 0x0026, 0x003a, 0x0093 }, /* NtCreateEventPair */
	{ 0x0017, 0x0020, 0x0025, 0x0027, 0x003b, 0x0052 }, /* NtCreateFile */
	{ 0x0018, 0x0021, 0x0026, 0x0028, 0x003c, 0x0094 }, /* NtCreateIoCompletion */
	{ 0x0019, 0x0023, 0x0029, 0x002b, 0x003f, 0x001a }, /* NtCreateKey */
	{ 0x001a, 0x0024, 0x002a, 0x002c, 0x0040, 0x0099 }, /* NtCreateMailslotFile */
	{ 0x001b, 0x0025, 0x002b, 0x002d, 0x0041, 0x009a }, /* NtCreateMutant */
	{ 0x001c, 0x0026, 0x002c, 0x002e, 0x0042, 0x009b }, /* NtCreateNamedPipeFile */
	{ 0x001d, 0x0027, 0x002d, 0x002f, 0x0044, 0x009c }, /* NtCreatePagingFile */
	{ 0x001e, 0x0028, 0x002e, 0x0030, 0x0045, 0x009d }, /* NtCreatePort */
	{ 0x001f, 0x0029, 0x002f, 0x0031, 0x0046, 0x009f }, /* NtCreateProcess */
	{ 0x0020, 0x002a, 0x0031, 0x0033, 0x0048, 0x00a0 }, /* NtCreateProfile */
	{ 0x0021, 0x002b, 0x0032, 0x0034, 0x0049, 0x0054 }, /* NtCreateSection */
	{ 0x0022, 0x002c, 0x0033, 0x0035, 0x004a, 0x00a3 }, /* NtCreateSemaphore */
	{ 0x0023, 0x002d, 0x0034, 0x0036, 0x004b, 0x00a4 }, /* NtCreateSymbolicLinkObject */
	{ 0x0024, 0x002e, 0x0035, 0x0037, 0x004c, 0x004b }, /* NtCreateThread */
	{ 0x0025, 0x002f, 0x0036, 0x0038, 0x004d, 0x00a6 }, /* NtCreateTimer */
	{ 0x0026, 0x0030, 0x0037, 0x0039, 0x004e, 0x00a7 }, /* NtCreateToken */
	{ 0x0027, 0x0032, 0x003b, 0x003d, 0x0075, 0x0031 }, /* NtDelayExecution */
	{ 0x0028, 0x0033, 0x003c, 0x003e, 0x0076, 0x00af }, /* NtDeleteAtom */
	{ 0x0029, 0x0034, 0x003e, 0x0041, 0x0079, 0x00b2 }, /* NtDeleteFile */
	{ 0x002a, 0x0035, 0x003f, 0x0042, 0x007a, 0x00b3 }, /* NtDeleteKey */
	{ 0x002b, 0x0036, 0x0040, 0x0043, 0x007c, 0x00b4 }, /* NtDeleteObjectAuditAlarm */
	{ 0x002c, 0x0037, 0x0041, 0x0044, 0x007d, 0x00b6 }, /* NtDeleteValueKey */
	{ 0x002d, 0x0038, 0x0042, 0x0045, 0x007e, 0x0004 }, /* NtDeviceIoControlFile */
	{ 0x002e, 0x0039, 0x0043, 0x0046, 0x007f, 0x00b8 }, /* NtDisplayString */
	{ 0x002f, 0x003a, 0x0044, 0x0047, 0x0080, 0x0039 }, /* NtDuplicateObject */
	{ 0x0030, 0x003b, 0x0045, 0x0048, 0x0081, 0x003f }, /* NtDuplicateToken */
	{ 0x0031, 0x003c, 0x0047, 0x004b, 0x0084, 0x002f }, /* NtEnumerateKey */
	{ 0x0032, 0x003d, 0x0049, 0x004d, 0x0086, 0x0010 }, /* NtEnumerateValueKey */
	{ 0x0033, 0x003e, 0x004a, 0x004e, 0x0087, 0x00bf }, /* NtExtendSection */
	{ 0x0034, 0x0040, 0x004c, 0x0050, 0x0089, 0x0011 }, /* NtFindAtom */
	{ 0x0035, 0x0041, 0x004d, 0x0051, 0x008a, 0x0048 }, /* NtFlushBuffersFile */
	{ 0x0036, 0x0042, 0x004e, 0x0052, 0x008b, 0x00c2 }, /* NtFlushInstructionCache */
	{ 0x0037, 0x0043, 0x004f, 0x0053, 0x008c, 0x00c3 }, /* NtFlushKey */
	{ 0x0038, 0x0044, 0x0050, 0x0054, 0x008e, 0x00c5 }, /* NtFlushVirtualMemory */
	{ 0x0039, 0x0045, 0x0051, 0x0055, 0x008f, 0x00c6 }, /* NtFlushWriteBuffer */
	{ 0x003a, 0x0047, 0x0053, 0x0057, 0x0091, 0x001b }, /* NtFreeVirtualMemory */
	{ 0x003b, 0x0048, 0x0054, 0x0058, 0x0094, 0x0036 }, /* NtFsControlFile */
	{ 0x003c, 0x0049, 0x0055, 0x0059, 0x0095, 0x00ca }, /* NtGetContextThread */
	{ 0x003d, 0x004b, 0x0057, 0x005b, 0x0098, 0x00d2 }, /* NtGetPlugPlayEvent */
	{ 0x003f, 0x004f, 0x005a, 0x005e, 0x009b, 0x001c }, /* NtImpersonateClientOfPort */
	{ 0x0040, 0x0050, 0x005b, 0x005f, 0x009c, 0x00d5 }, /* NtImpersonateThread */
	{ 0x0041, 0x0051, 0x005c, 0x0060, 0x009e, 0x00d7 }, /* NtInitializeRegistry */
	{ 0x0042, 0x0054, 0x0060, 0x0064, 0x00a2, 0x00db }, /* NtListenPort */
	{ 0x0043, 0x0055, 0x0061, 0x0065, 0x00a3, 0x00dc }, /* NtLoadDriver */
	{ 0x0044, 0x0056, 0x0062, 0x0066, 0x00a4, 0x00dd }, /* NtLoadKey */
	{ 0x0045, 0x0057, 0x0063, 0x0067, 0x00a5, 0x00de }, /* NtLoadKey2 */
	{ 0x0046, 0x0058, 0x0064, 0x0069, 0x00a7, 0x00e0 }, /* NtLockFile */
	{ 0x0047, 0x0059, 0x0067, 0x006c, 0x00aa, 0x00e3 }, /* NtLockVirtualMemory */
	{ 0x0048, 0x005a, 0x0069, 0x006e, 0x00ac, 0x00e5 }, /* NtMakeTemporaryObject */
	{ 0x0049, 0x005d, 0x006c, 0x0071, 0x00af, 0x0025 }, /* NtMapViewOfSection */
	{ 0x004a, 0x005e, 0x006e, 0x0074, 0x00b2, 0x00ea }, /* NtNotifyChangeDirectoryFile */
	{ 0x004b, 0x005f, 0x006f, 0x0075, 0x00b3, 0x00eb }, /* NtNotifyChangeKey */
	{ 0x004c, 0x0061, 0x0071, 0x0077, 0x00b5, 0x0055 }, /* NtOpenDirectoryObject */
	{ 0x004d, 0x0062, 0x0072, 0x0078, 0x00b6, 0x003D }, /* NtOpenEvent */
	{ 0x004e, 0x0063, 0x0073, 0x0079, 0x00b7, 0x00ef }, /* NtOpenEventPair */
	{ 0x004f, 0x0064, 0x0074, 0x007a, 0x00b8, 0x0030 }, /* NtOpenFile */
	{ 0x0050, 0x0065, 0x0075, 0x007b, 0x00b9, 0x00f0 }, /* NtOpenIoCompletion */
	{ 0x0051, 0x0067, 0x0077, 0x007d, 0x00bb, 0x000f }, /* NtOpenKey */
	{ 0x0052, 0x0068, 0x0078, 0x007e, 0x00bc, 0x00f6 }, /* NtOpenMutant */
	{ 0x0053, 0x0069, 0x0079, 0x007f, 0x00be, 0x00f7 }, /* NtOpenObjectAuditAlarm */
	{ 0x0054, 0x006a, 0x007a, 0x0080, 0x00bf, 0x0023 }, /* NtOpenProcess */
	{ 0x0055, 0x006b, 0x007b, 0x0081, 0x00c0, 0x00f9 }, /* NtOpenProcessToken */
	{ 0x0056, 0x006c, 0x007d, 0x0083, 0x00c2, 0x0034 }, /* NtOpenSection */
	{ 0x0057, 0x006d, 0x007e, 0x0084, 0x00c3, 0x00fb }, /* NtOpenSemaphore */
	{ 0x0058, 0x006e, 0x007f, 0x0085, 0x00c5, 0x00fd }, /* NtOpenSymbolicLinkObject */
	{ 0x0059, 0x006f, 0x0080, 0x0086, 0x00c6, 0x00fe }, /* NtOpenThread */
	{ 0x005a, 0x0070, 0x0081, 0x0087, 0x00c7, 0x00c7 }, /* NtOpenThreadToken */
	{ 0x005b, 0x0071, 0x0083, 0x0089, 0x00c9, 0x00ff }, /* NtOpenTimer */
	{ 0x005c, 0x0072, 0x0084, 0x008a, 0x00ca, 0x0102 }, /* NtPlugPlayControl */
	{ 0x005d, 0x0074, 0x0086, 0x008c, 0x00cc, 0x0107 }, /* NtPrivilegeCheck */
	{ 0x005f, 0x0076, 0x0087, 0x008d, 0x00cd, 0x0108 }, /* NtPrivilegeObjectAuditAlarm */
	{ 0x005e, 0x0075, 0x0088, 0x008e, 0x00ce, 0x0109 }, /* NtPrivilegedServiceAuditAlarm */
	{ 0x0060, 0x0077, 0x0089, 0x008f, 0x00cf, 0x004D }, /* NtProtectVirtualMemory */
	{ 0x0061, 0x0078, 0x008a, 0x0090, 0x00d0, 0x010c }, /* NtPulseEvent */
	{ 0x0063, 0x007a, 0x008b, 0x0091, 0x00d1, 0x003a }, /* NtQueryAttributesFile */
	{ 0x0064, 0x007b, 0x008f, 0x0095, 0x00d5, 0x0012 }, /* NtQueryDefaultLocale */
	{ 0x0065, 0x007d, 0x0091, 0x0097, 0x00d7, 0x0032 }, /* NtQueryDirectoryFile */
	{ 0x0066, 0x007e, 0x0092, 0x0098, 0x00d8, 0x0110 }, /* NtQueryDirectoryObject */
	{ 0x0067, 0x007f, 0x0093, 0x009a, 0x00da, 0x0112 }, /* NtQueryEaFile */
	{ 0x0068, 0x0080, 0x0094, 0x009b, 0x00db, 0x0053 }, /* NtQueryEvent */
	{ 0x0069, 0x0081, 0x0095, 0x009c, 0x00dc, 0x0114 }, /* NtQueryFullAttributesFile */
	{ 0x0062, 0x0079, 0x0096, 0x009d, 0x00dd, 0x00e5 }, /* NtQueryInformationAtom */
	{ 0x006a, 0x0082, 0x0097, 0x009e, 0x00de, 0x000e }, /* NtQueryInformationFile */
	{ 0x006c, 0x0085, 0x0099, 0x00a0, 0x00e0, 0x0117 }, /* NtQueryInformationPort */
	{ 0x006d, 0x0086, 0x009a, 0x00a1, 0x00e1, 0x0016 }, /* NtQueryInformationProcess */
	{ 0x006e, 0x0087, 0x009b, 0x00a2, 0x00e2, 0x0022 }, /* NtQueryInformationThread */
	{ 0x006f, 0x0088, 0x009c, 0x00a3, 0x00e3, 0x001e }, /* NtQueryInformationToken */
	{ 0x0070, 0x008a, 0x009e, 0x00a5, 0x00e5, 0x011d }, /* NtQueryIntervalProfile */
	{ 0x006b, 0x0084, 0x009f, 0x00a6, 0x00e6, 0x011e }, /* NtQueryIoCompletion */
	{ 0x0071, 0x008b, 0x00a0, 0x00a7, 0x00e7, 0x0013 }, /* NtQueryKey */
	{ 0x0072, 0x008c, 0x00a1, 0x00a8, 0x00e8, 0x0120 }, /* NtQueryMultipleValueKey */
	{ 0x0073, 0x008d, 0x00a2, 0x00a9, 0x00e9, 0x0121 }, /* NtQueryMutant */
	{ 0x0074, 0x008e, 0x00a3, 0x00aa, 0x00ea, 0x000d }, /* NtQueryObject */
	{ 0x0076, 0x0090, 0x00a5, 0x00ad, 0x00ed, 0x002e }, /* NtQueryPerformanceCounter */
	{ 0x0077, 0x0092, 0x00a7, 0x00af, 0x00ef, 0x004e }, /* NtQuerySection */
	{ 0x0078, 0x0093, 0x00a8, 0x00b0, 0x00f0, 0x0127 }, /* NtQuerySecurityObject */
	{ 0x0079, 0x0094, 0x00a9, 0x00b1, 0x00f1, 0x0128 }, /* NtQuerySemaphore */
	{ 0x007a, 0x0095, 0x00aa, 0x00b2, 0x00f2, 0x0129 }, /* NtQuerySymbolicLinkObject */
	{ 0x007b, 0x0096, 0x00ab, 0x00b3, 0x00f3, 0x012A }, /* NtQuerySystemEnvironmentValue */
	{ 0x007c, 0x0097, 0x00ad, 0x00b5, 0x00f5, 0x0033 }, /* NtQuerySystemInformation */
	{ 0x007d, 0x0098, 0x00ae, 0x00b6, 0x00f6, 0x0057 }, /* NtQuerySystemTime */
	{ 0x007e, 0x0099, 0x00af, 0x00b7, 0x00f7, 0x0035 }, /* NtQueryTimer */
	{ 0x007f, 0x009a, 0x00b0, 0x00b8, 0x00f8, 0x012d }, /* NtQueryTimerResolution */
	{ 0x0080, 0x009b, 0x00b1, 0x00b9, 0x00f9, 0x0014 }, /* NtQueryValueKey */
	{ 0x0081, 0x009c, 0x00b2, 0x00ba, 0x00fa, 0x0020 }, /* NtQueryVirtualMemory */
	{ 0x0082, 0x009d, 0x00b3, 0x00bb, 0x00fb, 0x0046 }, /* NtQueryVolumeInformationFile */
	{ 0x0083, 0x009e, 0x00b4, 0x00bc, 0x00fc, 0x0042 }, /* NtQueueApcThread */
	{ 0x0084, 0x009f, 0x00b5, 0x00bd, 0x00fd, 0x012f }, /* NtRaiseException */
	{ 0x0085, 0x00a0, 0x00b6, 0x00be, 0x00fe, 0x0130 }, /* NtRaiseHardError */
	{ 0x0086, 0x00a1, 0x00b7, 0x00bf, 0x00ff, 0x0003 }, /* NtReadFile */
	{ 0x0087, 0x00a2, 0x00b8, 0x00c0, 0x0100, 0x002b }, /* NtReadFileScatter */
	{ 0x0088, 0x00a3, 0x00b9, 0x00c1, 0x0101, 0x0051 }, /* NtReadRequestData */
	{ 0x0089, 0x00a4, 0x00ba, 0x00c2, 0x0102, 0x003c }, /* NtReadVirtualMemory */
	{ 0x008a, 0x00a5, 0x00bb, 0x00c3, 0x0103, 0x0136 }, /* NtRegisterThreadTerminatePort */
	{ 0x008b, 0x00a6, 0x00bc, 0x00c4, 0x0104, 0x001d }, /* NtReleaseMutant */
	{ 0x008c, 0x00a7, 0x00bd, 0x00c5, 0x0105, 0x0007 }, /* NtReleaseSemaphore */
	{ 0x008d, 0x00a8, 0x00be, 0x00c6, 0x0106, 0x0006 }, /* NtRemoveIoCompletion */
	{ 0x008e, 0x00a9, 0x00c1, 0x00c9, 0x0109, 0x013d }, /* NtReplaceKey */
	{ 0x008f, 0x00aa, 0x00c2, 0x00ca, 0x010a, 0x0009 }, /* NtReplyPort */
	{ 0x0090, 0x00ab, 0x00c3, 0x00cb, 0x010b, 0x0008 }, /* NtReplyWaitReceivePort */
	{ 0x0091, 0x00ad, 0x00c5, 0x00cd, 0x010d, 0x013f }, /* NtReplyWaitReplyPort */
	{ 0x0092, 0x00af, 0x00c7, 0x00cf, 0x010f, 0x0140 }, /* NtRequestPort */
	{ 0x0093, 0x00b0, 0x00c8, 0x00d0, 0x0110, 0x001f }, /* NtRequestWaitReplyPort */
	{ 0x0094, 0x00b2, 0x00ca, 0x00d2, 0x0112, 0x0141 }, /* NtResetEvent */
	{ 0x0095, 0x00b4, 0x00cc, 0x00d4, 0x0114, 0x0143 }, /* NtRestoreKey */
	{ 0x0096, 0x00b5, 0x00ce, 0x00d6, 0x0116, 0x004f }, /* NtResumeThread */
	{ 0x0097, 0x00b6, 0x00cf, 0x00d7, 0x0117, 0x0149 }, /* NtSaveKey */
	{ 0x0099, 0x00ba, 0x00d5, 0x00dd, 0x0122, 0x0150 }, /* NtSetContextThread */
	{ 0x009a, 0x00bb, 0x00d7, 0x00df, 0x0124, 0x0152 }, /* NtSetDefaultHardErrorPort */
	{ 0x009b, 0x00bc, 0x00d8, 0x00e0, 0x0125, 0x0153 }, /* NtSetDefaultLocale */
	{ 0x009c, 0x00be, 0x00da, 0x00e3, 0x0128, 0x0156 }, /* NtSetEaFile */
	{ 0x009d, 0x00bf, 0x00db, 0x00e4, 0x0129, 0x000b }, /* NtSetEvent */
	{ 0x009e, 0x00c0, 0x00dd, 0x00e6, 0x012b, 0x0157 }, /* NtSetHighEventPair */
	{ 0x009f, 0x00c1, 0x00de, 0x00e7, 0x012c, 0x0158 }, /* NtSetHighWaitLowEventPair */
	{ 0x00a1, 0x00c2, 0x00e0, 0x00e9, 0x012e, 0x0024 }, /* NtSetInformationFile */
	{ 0x00a2, 0x00c4, 0x00e2, 0x00eb, 0x0130, 0x015c }, /* NtSetInformationKey */
	{ 0x00a3, 0x00c5, 0x00e3, 0x00ec, 0x0131, 0x0059 }, /* NtSetInformationObject */
	{ 0x00a4, 0x00c6, 0x00e4, 0x00ed, 0x0132, 0x0019 }, /* NtSetInformationProcess */
	{ 0x00a5, 0x00c7, 0x00e5, 0x00ee, 0x0133, 0x000A }, /* NtSetInformationThread */
	{ 0x00a6, 0x00c8, 0x00e6, 0x00ef, 0x0134, 0x015e }, /* NtSetInformationToken */
	{ 0x00a7, 0x00c9, 0x00e7, 0x00f0, 0x0135, 0x0162 }, /* NtSetIntervalProfile */
	{ 0x0098, 0x00b9, 0x00e8, 0x00f1, 0x0136, 0x0163 }, /* NtSetIoCompletion */
	{ 0x00a8, 0x00ca, 0x00e9, 0x00f2, 0x0137, 0x0165 }, /* NtSetLdtEntries */
	{ 0x00a9, 0x00cb, 0x00ea, 0x00f3, 0x0138, 0x0166 }, /* NtSetLowEventPair */
	{ 0x00aa, 0x00cc, 0x00eb, 0x00f4, 0x0139, 0x0167 }, /* NtSetLowWaitHighEventPair */
	{ 0x00ac, 0x00ce, 0x00ed, 0x00f6, 0x013b, 0x0169 }, /* NtSetSecurityObject */
	{ 0x00ad, 0x00cf, 0x00ee, 0x00f7, 0x013c, 0x016a }, /* NtSetSystemEnvironmentValue */
	{ 0x00ae, 0x00d0, 0x00f0, 0x00f9, 0x013e, 0x016c }, /* NtSetSystemInformation */
	{ 0x00af, 0x00d1, 0x00f1, 0x00fa, 0x013f, 0x016d }, /* NtSetSystemPowerState */
	{ 0x00b0, 0x00d2, 0x00f2, 0x00fb, 0x0140, 0x016e }, /* NtSetSystemTime */
	{ 0x00b1, 0x00d4, 0x00f4, 0x00fd, 0x0142, 0x005f }, /* NtSetTimer */
	{ 0x00b2, 0x00d5, 0x00f5, 0x00fe, 0x0143, 0x0171 }, /* NtSetTimerResolution */
	{ 0x00b3, 0x00d7, 0x00f7, 0x0100, 0x0145, 0x005d }, /* NtSetValueKey */
	{ 0x00b4, 0x00d8, 0x00f8, 0x0101, 0x0146, 0x0173 }, /* NtSetVolumeInformationFile */
	{ 0x00b5, 0x00d9, 0x00f9, 0x0102, 0x0147, 0x0174 }, /* NtShutdownSystem */
	{ 0x00b6, 0x00da, 0x00fa, 0x0103, 0x0148, 0x0176 }, /* NtSignalAndWaitForSingleObject */
	{ 0x00b7, 0x00db, 0x00fb, 0x0104, 0x0149, 0x0178 }, /* NtStartProfile */
	{ 0x00b8, 0x00dc, 0x00fc, 0x0105, 0x014a, 0x0179 }, /* NtStopProfile */
	{ 0x00b9, 0x00dd, 0x00fe, 0x0107, 0x014c, 0x017b }, /* NtSuspendThread */
	{ 0x00ba, 0x00de, 0x00ff, 0x0108, 0x014d, 0x017c }, /* NtSystemDebugControl */
	{ 0x00bb, 0x00e0, 0x0101, 0x010a, 0x014f, 0x0029 }, /* NtTerminateProcess */
	{ 0x00bc, 0x00e1, 0x0102, 0x010b, 0x0150, 0x0050 }, /* NtTerminateThread */
	{ 0x00bd, 0x00e2, 0x0103, 0x010c, 0x0151, 0x017e }, /* NtTestAlert */
	{ 0x00be, 0x00e3, 0x0106, 0x010f, 0x0157, 0x0184 }, /* NtUnloadDriver */
	{ 0x00bf, 0x00e4, 0x0107, 0x0110, 0x0158, 0x0185 }, /* NtUnloadKey */
	{ 0x00c0, 0x00e5, 0x0109, 0x0113, 0x015b, 0x0188 }, /* NtUnlockFile */
	{ 0x00c1, 0x00e6, 0x010a, 0x0114, 0x015c, 0x0189 }, /* NtUnlockVirtualMemory */
	{ 0x00c2, 0x00e7, 0x010b, 0x0115, 0x015d, 0x0027 }, /* NtUnmapViewOfSection */
	{ 0x00c3, 0x00e8, 0x010c, 0x0116, 0x015e, 0x018a }, /* NtVdmControl */
	{ 0x00c4, 0x00e9, 0x010e, 0x0118, 0x0160, 0x0058 }, /* NtWaitForMultipleObjects */
	{ 0x00c5, 0x00ea, 0x010f, 0x0119, 0x0161, 0x0001 }, /* NtWaitForSingleObject */
	{ 0x00c6, 0x00eb, 0x0110, 0x011a, 0x0162, 0x018e }, /* NtWaitHighEventPair */
	{ 0x00c7, 0x00ec, 0x0111, 0x011b, 0x0163, 0x018f }, /* NtWaitLowEventPair */
	{ 0x00c8, 0x00ed, 0x0112, 0x011c, 0x0164, 0x0005 }, /* NtWriteFile */
	{ 0x00c9, 0x00ee, 0x0113, 0x011d, 0x0165, 0x0018 }, /* NtWriteFileGather */
	{ 0x00ca, 0x00ef, 0x0114, 0x011e, 0x0166, 0x0054 }, /* NtWriteRequestData */
	{ 0x00cb, 0x00f0, 0x0115, 0x011f, 0x0167, 0x0037 }, /* NtWriteVirtualMemory */
	{ 0x00d3, 0x00f7, 0x0116, 0x0120, 0x0168, 0x0043 }  /* NtYieldExecution */
};

static void SetServices()
{
	DWORD_PTR *PEB;
	DWORD_PTR winMajor, winMinor;

	#if _M_IX86
		PEB = (DWORD_PTR*) __readfsdword(0x30);
	#elif _M_X64
		PEB = (DWORD_PTR*) __readgsqword(0x60);
	#endif

	winMajor = *(PEB + (0xA4 / sizeof(DWORD_PTR)));
	winMinor = *(PEB + (0xA8 / sizeof(DWORD_PTR)));

	if(winMajor == 6)
		if(winMinor == 0)
			_Version = 4;
		else
			_Version = 5;

	else if(winMajor == 5)
	{
		if(winMinor == 0)
			_Version = 1;
		else if(winMinor == 1)
			_Version = 2;
		else if(winMinor == 2)
			_Version = 3;
	}

	else if(winMajor == 4)
		_Version = 0;
}

extern "C"
{
	__declspec(naked) static void __cdecl __adjustESP(int)
	{
		__asm
		{
			pop eax
			add esp, [esp]
			jmp eax
		}
	}

	__declspec(naked) static void __cdecl __moveEAX(int)
	{
		__asm
		{
			pop ecx
			mov eax, [esp]
			jmp ecx
		}
	}

	__declspec(naked) static NTSTATUS __cdecl KiFastSystemCall()
	{
		__asm
		{
			lea edx, [esp + 8]
			INT 46
			retn
		}
	}
}

NTSTATUS FastSystemCall(size_t _RequestID, ...)
{
	ASSERTUME(_RequestID >= 0);
	ASSERTUME(_RequestID < _countof(syscallTable));

	NTSTATUS returnVal;

	DWORD_PTR _BasePointer = *((DWORD_PTR*)_AddressOfReturnAddress() - (4 / sizeof(DWORD_PTR*)));
	DWORD_PTR _RetAddress = (DWORD_PTR)_ReturnAddress();

	ONCE(
		SetServices();
	);

	#ifdef _M_IX86
		__adjustESP(16);
		__moveEAX(syscallTable[_RequestID][_Version]);
	#elif _M_X64
		__adjustRSP(32);
		__moveRAX(syscallTable[_RequestID][_Version]);
	#endif

	returnVal = KiFastSystemCall();

	#ifdef _M_IX86
		__adjustESP(-16);
	#elif _M_X64
		__adjustRSP(-32);
	#endif

	*((DWORD_PTR*) _AddressOfReturnAddress() - (4 / sizeof(DWORD_PTR*))) = _BasePointer;
	*((DWORD_PTR*) _AddressOfReturnAddress()) = _RetAddress;

	return returnVal;
}